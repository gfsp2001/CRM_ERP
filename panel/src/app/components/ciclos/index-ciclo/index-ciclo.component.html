<div class="d-flex flex-column flex-root">
  <div class="d-flex flex-row flex-column-fluid page">
    <app-sidebar></app-sidebar>
    <div class="d-flex flex-column flex-row-fluid wrapper" id="kt_wrapper">
      <app-top></app-top>
      <!--begin::Content-->
      <div class="content d-flex flex-column flex-column-fluid" id="kt_content">
        <!--begin::Subheader-->
        <div class="subheader py-2 py-lg-4 subheader-solid" id="kt_subheader">
          <div class="container-fluid d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">
            <!--begin::Info-->
            <div class="d-flex align-items-center flex-wrap mr-2">
              <!--begin::Page Title-->
              <h5 class="text-dark font-weight-bold mt-2 mb-2 mr-5">
                Cursos
              </h5>
              <!--end::Page Title-->
              <!--begin::Actions-->
              <div class="subheader-separator subheader-separator-ver mt-2 mb-2 mr-4 bg-gray-200"></div>
              <ul class="breadcrumb breadcrumb-transparent breadcrumb-dot font-weight-bold p-0 my-2 font-size-sm">

                <li class="breadcrumb-item text-muted">
                  <a [routerLink]="['/cursos']" class="text-muted">Listado de cursos</a>
                </li>
                <li class="breadcrumb-item active">
                  <a>Ciclos vigentes</a>
                </li>
              </ul>
              <!--end::Actions-->
            </div>
            <!--end::Info-->
          </div>
        </div>
        <!--end::Subheader-->
        <!--begin::Entry-->
        <div class="d-flex flex-column-fluid">
          <!--begin::Container-->
          <div class="container">
            <div *ngIf="load_data" class="row mt-5">
              <div class="col-12 text-center">
                <div class="spinner-border" style="width: 3rem; height: 3rem" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>
            </div>
            <ng-container *ngIf="!load_data">
              <ng-container *ngIf="data">
                <div class="card card-custom card-stretch gutter-b">
                  <!--begin::Header-->
                  <div class="card-header border-0 mt-5">
                    <h3 class="card-title align-items-start flex-column text-dark">
                      <span class="font-weight-bolder text-dark">Ciclos vigentes</span>
                      <span class="text-muted mt-3 font-weight-bold font-size-sm">Solo se muestran cursos con clases
                        vigentes</span>
                    </h3>
                    <div class="card-toolbar">
                      <a [routerLink]="['/cursos/' + id + '/ciclo/vencidos']"
                        class="btn btn-info btn-sm font-weight-bold font-size-sm mr-3">Ir a vencidos</a>

                      <a [routerLink]="['/cursos/' + id + '/ciclo/create']"
                        class="btn btn-primary btn-sm font-weight-bold font-size-sm mr-3">Nuevo ciclo</a>
                    </div>
                  </div>
                  <!--end::Header-->
                  <!--begin::Body-->
                  <div class="card-body py-0 mt-n3">
                    <!--begin::Search Form-->
                    <div class="mb-7">
                      <div class="row align-items-center">
                        <div class="col-lg-9 col-xl-8">
                          <div class="row align-items-center">
                            <div class="col-md-5 my-2 my-md-0">
                              <div class="d-flex align-items-center">
                                <label class="mr-3 mb-0 d-none d-md-block">Nivel:</label>
                                <select class="form-control" name="filtro" [(ngModel)]="filtro">
                                  <option value="Todos">Todos</option>
                                  <option value="Basico 1">Basico 1</option>
                                  <option value="Basico 2">Basico 2</option>
                                  <option value="Basico 3">Basico 3</option>
                                  <option value="Intermedio 1">
                                    Intermedio 1
                                  </option>
                                  <option value="Intermedio 2">
                                    Intermedio 2
                                  </option>
                                  <option value="Intermedio 2">
                                    Intermedio 3
                                  </option>
                                  <option value="Avanzado 1">Avanzado 1</option>
                                  <option value="Avanzado 2">Avanzado 2</option>
                                  <option value="Avanzado 3">Avanzado 3</option>
                                </select>
                              </div>
                            </div>
                            <div class="col">
                              <a (click)=" filtrar()" style="cursor: pointer"
                                class="btn btn-light-primary px-6 font-weight-bold">Buscar</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <table class="table table-borderless table-vertical-center">
                      <thead>
                        <tr>
                          <th class="p-0" style="width: 50px"></th>
                          <th class="p-0" style="min-width: 120px"></th>
                          <th class="p-0" style="min-width: 100px"></th>
                          <th class="p-0" style="min-width: 100px"></th>
                          <th class="p-0" style="min-width: 70px"></th>
                          <th class="p-0" style="min-width: 70px"></th>
                          <th class="p-0" style="min-width: 70px"></th>
                        </tr>
                      </thead>
                      <tbody *ngIf="ciclos.length">
                        <ng-container *ngFor="let item of ciclos">
                          <tr style="background: #f6f4ff">
                            <td colspan="7">
                              <div>
                                <p style="margin-bottom: 0px">
                                  <b class="badge badge-dark">Código ciclo:</b>
                                  &nbsp; #{{ item.ciclo._id }}
                                </p>
                              </div>
                            </td>
                          </tr>
                          <tr style="background: #f6f4ff">
                            <td class="pl-4">
                              <div class="symbol symbol-50 symbol-fixed mr-2 mt-2">
                                <div class="symbol-label" style="
                                  background-image:
                                  url('{{ url }}get_image_curso/{{item.ciclo.curso.banner}}')"></div>
                              </div>
                            </td>
                            <td class="pl-0">
                              <a class="text-dark font-weight-bolder text-hover-primary mb-1 font-size-lg">
                                {{item.ciclo.nivel}}
                              </a>
                              <span class="text-muted font-weight-bold d-block">
                                {{item.ciclo.f_inicio|date}} - {{item.ciclo.f_fin|date}}
                              </span>
                            </td>
                            <td>
                              <span class="text-dark font-weight-bolder text-hover-primary mb-1 font-size-lg">
                                <ng-container *ngFor="let subitem of item.ciclo.meses; let ultimo = last">
                                  <ng-container *ngFor="let mes of arrMeses; let indice = index">
                                    <span *ngIf="subitem==indice+1">{{mes}}<ng-container
                                        *ngIf="!ultimo && item.ciclo.meses.length > 1">, </ng-container>
                                    </span>
                                  </ng-container>
                                </ng-container>
                              </span>
                              <span class=" text-muted font-weight-bold d-block">
                                Ciclos
                              </span>
                            </td>

                            <td>
                              <a class="text-dark font-weight-bolder text-hover-primary mb-1 font-size-lg">
                                {{item.ciclo.sede}}
                              </a>
                              <span class=" text-muted font-weight-bold d-block">
                                Sede
                              </span>
                            </td>
                            <td class="text-center">
                              <ng-container *ngIf="item.ciclo.estado">
                                <span class="badge badge-success">Publicado</span>
                              </ng-container>
                              <ng-container *ngIf="!item.ciclo.estado">
                                <span class="badge badge-warning">Borrador</span>
                              </ng-container>
                            </td>

                            <td class="text-right">
                              <span class="text-dark font-weight-bolder text-hover-primary mb-1 font-size-lg">
                                {{item.ciclo.createdAt | date}}
                              </span>
                              <span class="text-muted font-weight-bold d-block">
                                Creación
                              </span>
                            </td>
                            <td class="text-right pr-4">
                              <div class="dropdown dropdown-inline dropleft">
                                <button type="button" class="btn btn-light-primary btn-icon btn-sm"
                                  data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                  <i class="ki ki-bold-more-ver"></i>
                                </button>
                                <div class="dropdown-menu">
                                  <a [routerLink]="['/cursos/'+id+'/ciclo/edit/'+item.ciclo._id]" class="dropdown-item">
                                    <i class="icon-1x text-dark-50 flaticon-edit"></i>
                                    &nbsp; Editar ciclo
                                  </a>
                                  <a style="cursor: pointer" class="dropdown-item" *ngIf="item.ciclo.estado"
                                    data-toggle="modal" [attr.data-target]="'#state-' + item.ciclo._id">
                                    <i class="icon-1x text-dark-50 flaticon2-cross"></i>
                                    &nbsp; Ocultar
                                  </a>
                                  <a style="cursor: pointer" class="dropdown-item" *ngIf="!item.ciclo.estado"
                                    data-toggle="modal" [attr.data-target]="'#state-' + item.ciclo._id">
                                    <i class="icon-1x text-dark-50 flaticon2-check-mark"></i>
                                    &nbsp; Publicar
                                  </a>
                                </div>
                              </div>


                              <div class="modal fade" id="state-{{ item.ciclo._id }}" tabindex="-1" role="dialog"
                                aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                  <div class="modal-content">
                                    <div class="modal-header">
                                      <h5 class="modal-title" id="exampleModalLabel">
                                        Cambiar estado del curso
                                      </h5>
                                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <i aria-hidden="true" class="ki ki-close"></i>
                                      </button>
                                    </div>
                                    <div class="text-center modal-body">
                                      <p>
                                        ¿Estás seguro que quieres cambiar el
                                        estado del ciclo en
                                        <b>
                                          <span class="badge badge-warning" *ngIf="item.ciclo.estado">
                                            Borrador</span>
                                          <span class="badge badge-success" *ngIf="!item.ciclo.estado">Publicado</span>
                                        </b>?
                                      </p>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-warning font-weight-bold"
                                        data-dismiss="modal">
                                        Cerrar
                                      </button>
                                      <button type="button" class="btn btn-danger font-weight-bold" *ngIf="!load_estado"
                                        (click)="set_state(item.ciclo._id, item.ciclo.estado)">
                                        Enviar
                                      </button>

                                      <button class="btn btn-danger" type="button" *ngIf="load_estado" disabled>
                                        <span class="spinner-border spinner-border-sm" role="status"
                                          aria-hidden="true"></span>
                                        Enviando...
                                      </button>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </td>

                          </tr>
                          <tr>
                            <td colspan="7">
                              <table class="table table-bordered table-sm table-striped" style="margin-bottom: 0px">
                                <ng-container>
                                  <thead>
                                    <th class="text-primary">Salón</th>
                                    <th class="text-primary">Horario</th>
                                    <th class="text-primary">Días</th>
                                    <th class="text-primary">Aforo</th>
                                  </thead>
                                  <tr *ngFor="let subitem of item.salones">
                                    <td style="max-width: 70px;">{{subitem.salon}}</td>
                                    <td style="max-width: 70px;">
                                      <span>{{subitem.h_inicio}}</span> - <span>{{subitem.h_fin}}</span>
                                    </td>
                                    <td style="max-width: 90px;">
                                      <span class="text-dark-75 font-weight-bolder d-block font-size-lg">
                                        <ng-container *ngFor=" let dia of subitem.f_dias; let ultimo = last">
                                          <span *ngIf="!ultimo">{{ dia.substr(0, 3) }}, </span>
                                          <span *ngIf="ultimo">{{ dia.substr(0, 3) }}</span>
                                        </ng-container>
                                      </span>
                                      <span class="text-muted font-weight-bold">Días</span>
                                    </td>
                                    <td style="max-width: 30px;">
                                      <strong>{{subitem.aforo_total}}</strong>
                                      <span>({{subitem.aforo_actual}})</span>
                                    </td>
                                  </tr>
                                </ng-container>
                              </table>
                            </td>
                          </tr>
                        </ng-container>
                      </tbody>
                      <tbody *ngIf="!ciclos.length">
                        <tr>
                          <td colspan="6" class="text-center">
                            <span class="text-muted">No se encontraron resultados.</span>
                          </td>
                        </tr>
                      </tbody>
                    </table>

                    <!--end::Table-->
                  </div>

                  <!--end::Body-->
                </div>
              </ng-container>
              <ng-container *ngIf="!data">
                <app-notfound></app-notfound>
              </ng-container>
            </ng-container>
            <!--end::Row-->
          </div>
          <!--end::Container-->
        </div>
        <!--end::Entry-->
      </div>
      <!--end::Content-->
    </div>
  </div>
</div>